name: Build and deploy frontend and backend app to Azure

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and zip apps
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Build all apps
        run: npm run build --if-present

      # ---------- FRONTEND ZIP ----------
      - name: Zip share-a-meal-web frontend
        run: |
          cd ${GITHUB_WORKSPACE}/dist/apps/share-a-meal-web
          zip ${GITHUB_WORKSPACE}/share-a-meal-web-release.zip ./* -r

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: share-a-meal-web
          path: share-a-meal-web-release.zip

      # ---------- BACKEND ZIP (compile JS + package.json) ----------
      - name: Prepare backend deploy folder
        run: |
          mkdir -p deploy/data-api
          # Copy compiled JS from dist
          cp -r dist/apps/data-api/* deploy/data-api/
          # Copy package.json for Azure start
          cp apps/data-api/package.json deploy/data-api/
          # Zip everything at root
          cd deploy
          zip -r ${GITHUB_WORKSPACE}/data-api-release.zip data-api/*

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: data-api
          path: data-api-release.zip

  deploy-share-a-meal-web:
    runs-on: ubuntu-latest
    name: Deploy Angular Frontend
    needs: build
    environment:
      name: Production

    steps:
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: share-a-meal-web

      - name: Unzip frontend artifact
        run: unzip share-a-meal-web-release.zip

      - name: Deploy Angular frontend to Azure
        id: builddeploy
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.ANGULAR_PUBLISHTOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: 'upload'
          app_location: '/'
          output_location: 'dist/apps/share-a-meal-web'
          github_id_token: ${{ steps.idtoken.outputs.result }}

  deploy-data-api:
    runs-on: ubuntu-latest
    name: Deploy NestJS data-api backend
    needs: build
    environment:
      name: Production

    steps:
      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: data-api

      - name: Unzip backend artifact
        run: unzip data-api-release.zip -d ./data-api

      - name: Deploy backend to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: f1blogger
          slot-name: Production
          publish-profile: ${{ secrets.NESTJS_PUBLISHPROFILE }}
          package: ./data-api
